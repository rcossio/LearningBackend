{{#if error}}
<div class="alert alert-danger mx-5">{{error}}</div>
{{/if}}

{{#if message}}
<div class="alert alert-info mx-5">{{message}}</div>
{{/if}}

<div class="container">
  <div class="row">
    <div class="col">
      <h2 class="text-center">Your Store</h2>

      {{#if docs}}
        {{#each docs}}
        <div class="card store_card--wider mx-auto mb-2" id="product-card-{{this._id}}">
          <div class="row no-gutters">
            <!-- Product Details -->
            <div class="col-md-7">
              <div class="card-body py-2">
                <h5 class="card-title text-sm">{{this.title}}</h5>
                <p class="card-text text-sm my-3">{{this.description}}</p>
                <p class="card-text text-sm my-0">Code: {{this.code}}</p>
                <p class="card-text text-sm my-0">Category: {{this.category}}</p>
              </div>
            </div>
            <!-- Update Form -->
            <div class="col-md-5 d-flex align-items-center position-relative">
              <form class="update-form" action="/api/products/{{this._id}}" method="POST">
                <div class="row form-row align-items-center">
                  <div class="col">
                    <div class="form-group my-1 d-flex align-items-center">
                      <label for="stock-{{this._id}}" class="me-2 mb-0">Stock:</label>
                      <input type="number" id="stock-{{this._id}}" name="stock" value="{{this.stock}}" class="form-control me-2 text-muted">
                    </div>
                    <div class="form-group my-1 d-flex align-items-center">
                      <label for="price-{{this._id}}" class="me-2 mb-0">Price:</label>
                      <input type="number" id="price-{{this._id}}" name="price" value="{{this.price}}" class="form-control text-muted">
                    </div>
                  </div>
                  <div class="col-auto">
                    <button type="button" class="btn btn-danger mb-1 me-3 update-button" data-id="{{this._id}}">Update</button>
                    <div class="my-1">
                      <button type="button" class="btn btn-link p-0 border-0 bg-transparent delete-button" data-id="{{this._id}}">
                        <i class="fas fa-trash-alt text-dark"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
        {{/each}}
      {{else}}
        <div class="text-center"> No products in your store </div>
      {{/if}}
    </div>
  </div>
  <div class="text-center">
      <a href="/add-product" class="btn btn-primary mt-2 px-4">Add a product</a>
  </div>

  <a href="/chat" class="btn btn-primary rounded-circle p-0 shadow d-flex justify-content-center align-items-center" style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px;">
    <i class="fas fa-comments text-white" style="font-size: 24px;"></i>
  </a>
</div>


<!-- Script for update and delete functionality -->
<script>
  document.querySelectorAll('.update-button').forEach(button => {
    button.addEventListener('click', event => {
      const productId = event.target.dataset.id;
      const form = document.querySelector(`form[action='/api/products/${productId}']`);
      const formData = new FormData(form);
      
      fetch(`/api/products/${productId}`, {
        method: 'PUT',
        body: JSON.stringify({
          stock: formData.get('stock'),
          price: formData.get('price')
        }),
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (response.ok) {
          alert('Product updated successfully');
          location.reload(); 
        } else {
          alert('Failed to update product');
        }
      })
      .catch(error => console.error('Error:', error));
    });
  });

  document.querySelectorAll('.delete-button').forEach(button => {
    button.addEventListener('click', event => {
      const productId = event.currentTarget.dataset.id;

      fetch(`/api/products/${productId}`, {
        method: 'DELETE'
      })
      .then(response => {
        if (response.ok) {
          alert('Product deleted successfully');
          location.reload(); 
        } else {
          alert('Failed to delete product');
        }
      })
      .catch(error => console.error('Error:', error));
    });
  });
</script>
